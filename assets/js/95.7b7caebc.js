(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{523:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("blockquote",[a("p",[s._v("在日常开发过程中，ci（持续集成）/cd（持续交付）是一个不可或缺的好帮手，有了他，开发者可以只专注于开发，把开发好后的构建部署一些列操作都交给ci机器人去做，大大的节省了人力成本。")])]),s._v(" "),a("h2",{attrs:{id:"什么是ci-cd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是ci-cd"}},[s._v("#")]),s._v(" 什么是ci/cd")]),s._v(" "),a("p",[s._v("先回想一下我们在每次开发完成之后部署站点都会经历哪几个过程")]),s._v(" "),a("ul",[a("li",[s._v("1.执行构建命令")]),s._v(" "),a("li",[s._v("2.将构建产物复制到服务器对应目录下")])]),s._v(" "),a("p",[s._v("这几个步骤其实都是重复的，而ci/cd就是通过一系列的脚本去机械化的完成这些操作，节省人力的同时还更不容易出错\n下面就以gitlab ci举个简单的例子")]),s._v(" "),a("h2",{attrs:{id:"gitlab-runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner"}},[s._v("#")]),s._v(" gitlab runner")]),s._v(" "),a("p",[s._v("gitlab中使用ci需要借助到runner")]),s._v(" "),a("ul",[a("li",[s._v("安装runner")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" gitlab-runner\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://docs.gitlab.com/runner/",target:"_blank",rel:"noopener noreferrer"}},[s._v("runner文档"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("-注册runner")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" gitlab-runner register\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("之后是QA式操作，按照提示语输入信息即可，可参考官网操作，需要注意：\n①. gitlab host和token在你的gitlab项目上找，页面路径是：Settings >> CI/CD >> Runners")]),s._v(" "),a("p",[s._v("②. runner执行器选择 docker，image（镜像）输入 node:8.11.2-stretch")]),s._v(" "),a("p",[s._v("注册成功后，我们就能在：Settings >> CI/CD >> Runners下看到我们注册的runner")]),s._v(" "),a("h3",{attrs:{id:"gitlab-runner配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner配置"}},[s._v("#")]),s._v(" Gitlab-Runner配置")]),s._v(" "),a("p",[s._v("在项目根目录下新建 .gitlab.yml文件，加入如下内容：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("stages:\n  - package\n  - upload\n  - build\n  - deploy\n  - notify\n\nvariables:\n  REGISTRY_NAME: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry-vpc.cn-hangzhou.aliyuncs.com/odbpo/"')]),s._v("\n  IMAGE_NAME: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${REGISTRY_NAME}")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_NAME}")]),s._v("\n  PORT: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"80"')]),s._v("\n  LIMIT_CPU: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("\n  LIMIT_MEMORY: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"200m"')]),s._v("\n  DEFAULT_ROUTER: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Host('),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("h5.dev.hunshehui.cn"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(")&&PathPrefix("),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("/cms"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(')"')]),s._v("\n  HEALTH_URL: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/index.html"')]),s._v("\n  CONTAINERS_NUM: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n\ncache: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("global_cache\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# `key`=`prefix`+`-`+`SHA(files)`")]),s._v("\n  key:\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 判定缓存是否需要更新的文件，最多两个")]),s._v("\n    files:\n      - package.json\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成目录的前缀，可以不定义")]),s._v("\n    prefix: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("\n  paths:\n    - node_modules\n    - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dist/"')]),s._v("\n\n\nnode-build:\n  image: node:14.17.0\n  stage: package\n  before_script:\n    - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'which ssh-agent || ( yum update -y && yum install openssh-client git -y ) '")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_PRIVATE_KEY_BELIFE")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\r'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ssh-add -\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" ~/.ssh\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v(" ~/.ssh\n    - ssh-keyscan "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP_KEY_TEST_BELIFE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/known_hosts\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("644")]),s._v(" ~/.ssh/known_hosts\n  script:\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将镜像源设置成淘宝镜像")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" registry https://registry.npmmirror.com\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run build:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run upload:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - ossutil64 config -e $OSS_END_POINT -i $OSS_ACCESS_KEY_ID -k $OSS_ACCESS_KEY_SECRET")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - ossutil64 cp -r -f dist/ oss://$OSS_BUCKET_NAME")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - ssh-keygen")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - ssh-copy-id -i .ssh/id_rsa.pub  root@8.222.250.20")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" ./dist/index.html root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP_KEY_TEST_BELIFE")]),s._v(":/mnt/belife-work/h5/\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - sshpass -p ZVd+KPxFMsANQp$T scp -r ./dist/index.html root@8.222.250.20:/mnt/belife-h5-app")]),s._v("\n  cache:\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(": *global_cache\n  artifacts:\n    name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CI_COMMIT_BRANCH")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CI_COMMIT_SHORT_SHA")]),s._v('"')]),s._v("\n    paths:\n      - dist/index.html\n  only:\n    - dev\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n    - pre\n    - main\n  tags:\n    - runner-vue-dev\n\nnotifySuccess:\n  image: appropriate/curl:latest\n  stage: notify\n  when: on_success\n  cache: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  script:\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://oapi.dingtalk.com/robot/send?access_token=80279843cd3236168a05e8f1cab5efb0df8a7a71f37cb4c61bc735bfe7c3bd47'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type:application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{'),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("msgtype"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("markdown"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("markdown"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("title"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("构建通知"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("text"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("# ["),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_NAME}")]),s._v("]("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_URL}")]),s._v(")"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 流水线：[#"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PIPELINE_ID}")]),s._v("]("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_URL}")]),s._v("/-/pipelines/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PIPELINE_ID}")]),s._v(")"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 状态：<font color=#52c41a>成功</font>"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 执行人："),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GITLAB_USER_EMAIL}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('}}"')]),s._v("\n  tags:\n    - runner-vue-dev\n  only:\n    - dev\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n    - main\n\nnotifyFailed:\n  image: appropriate/curl:latest\n  stage: notify\n  when: on_failure\n  cache: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  script:\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://oapi.dingtalk.com/robot/send?access_token=80279843cd3236168a05e8f1cab5efb0df8a7a71f37cb4c61bc735bfe7c3bd47'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type:application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{'),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("msgtype"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("markdown"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("markdown"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("title"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("构建通知"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("text"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("# ["),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_NAME}")]),s._v("]("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_URL}")]),s._v(")"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 流水线：[#"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PIPELINE_ID}")]),s._v("]("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PROJECT_URL}")]),s._v("/-/pipelines/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_PIPELINE_ID}")]),s._v(")"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 状态：<font color=#f5222d>失败</font>"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("- 执行人："),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${GITLAB_USER_EMAIL}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('}}"')]),s._v("\n  tags:\n    - runner-vue-dev\n  only:\n    - dev\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n    - main\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br")])]),a("p",[s._v("这里大致介绍一下里面的一些key都是什么意思")]),s._v(" "),a("ul",[a("li",[s._v("stages：定义任务，可配置多个")]),s._v(" "),a("li",[s._v("variables： 定义一些变量，可在下文中使用")]),s._v(" "),a("li",[s._v("每个job都可以指定stage，执行对应的stage时就回去执行对应的job，如上文示例中node-build指定了stage为package，那执行package这个stage的时候就回去执行node-build这个job。")]),s._v(" "),a("li",[s._v("剩下几个关键点可以自行百度一下。相信大概看一下也能猜到是做什么的了")])]),s._v(" "),a("p",[s._v("铺垫了这么多，下面终于可以开始进入正文了")]),s._v(" "),a("h2",{attrs:{id:"在ci过程中遇到的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在ci过程中遇到的问题"}},[s._v("#")]),s._v(" 在ci过程中遇到的问题")]),s._v(" "),a("p",[s._v("我们都知道部署是需要把最终的构建产物放到服务器上去的，那这里就不可避免的出现一个登录服务器的操作。而在ci脚本中是无法进行交互的，也就是说我们没办法去输入密码登录。那就只有想办法免密登录\n在ssh协议里有一个非常经典的操作，那就是公钥密钥验证，免密登录。而本文也正式采用这个方式。其实用过gitlab的应该都知道，gitlab里有一个操作就是本机生成ssh_key,然后将他添加到gitlab中既可以免密码拉代码。我们免密登录服务器就和这个差不多")]),s._v(" "),a("p",[s._v("如果你的runner是不变的，那只需要在runner里生成一个ssh_key然后将这个key放到服务器的/.ssh/authorized_keys文件里即可免密登录，而我们公司的runner是从镜像里拉出来的，也就是每次都不一样，所以无法采用刚刚说的那种办法。那另外一种办法就是，在某个机器生成一个ssh_key，将他放到服务器上，然后在ci里将这个key也放到runner里，相当于runner里的key现在是已经通过验证的了。这样就可以验证通过了。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" before_script:\n    - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'which ssh-agent || ( yum update -y && yum install openssh-client git -y ) '")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_PRIVATE_KEY_BELIFE")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\r'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ssh-add -\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" ~/.ssh\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v(" ~/.ssh\n    - ssh-keyscan "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP_KEY_TEST_BELIFE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/known_hosts\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("644")]),s._v(" ~/.ssh/known_hosts\n script:\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将镜像源设置成淘宝镜像")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" registry https://registry.npmmirror.com\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run build:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run upload:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CI_COMMIT_BRANCH}")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" ./dist/index.html root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP_KEY_TEST_BELIFE")]),s._v(":/mnt/belife-work/h5/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("$SSH_PRIVATE_KEY_BELIFE就是你本机生成的ssh_key，这里将他配置到了gitlab的变量里，$IP_KEY_TEST_BELIFE是你服务器的地址，也就是ip")]),s._v(" "),a("h2",{attrs:{id:"结语"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[s._v("#")]),s._v(" 结语")]),s._v(" "),a("p",[s._v("以上就是本文的全部内容，文中很多概念描述的比较笼统，主旨是为了解决如何免密登录服务器这个问题，至于ci脚本的编写，以及gitlab runner的安装啥的可自行搜索一下教程。ci/cd是工程化中重要的一环，身为一个合格的前端也应该去掌握。加油！")]),s._v(" "),a("p",[s._v("文章参考:\n"),a("a",{attrs:{href:"http://eyunzhu.com/1905",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用gitlab runner ci 通过ssh部署项目到远程服务器"),a("OutboundLink")],1),s._v(";")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/weixin_47656385/article/details/123043020",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用gitlab runner部署项目"),a("OutboundLink")],1),s._v(";")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/weixin_39568172/article/details/110642765",target:"_blank",rel:"noopener noreferrer"}},[s._v("gitlab配置ssh keys认证失败_用GitLab-Runner打造锋利的CI/CD"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);