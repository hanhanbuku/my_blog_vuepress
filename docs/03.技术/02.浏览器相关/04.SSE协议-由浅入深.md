---
title: SSEåè®®-ç”±æµ…å…¥æ·±
date: 2026-02-26 14:26:21
permalink: /pages/bb684e/
categories:
  - æŠ€æœ¯
  - æµè§ˆå™¨ç›¸å…³
tags:
  - 
---

## å‰è¨€

> è¯´èµ·å®¢æˆ·ç«¯æœåŠ¡ç«¯çš„é€šä¿¡åè®®ï¼Œå¤§å®¶æœ€ç†Ÿæ‚‰çš„å½“å±``http/https``ï¼Œ``websocket``è¿™ä¸¤ä¸ªå®¶ä¼™äº†ã€‚å‰è€…æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·ï¼ŒæœåŠ¡ç«¯å“åº”çš„å•é¡¹é€šä¿¡åè®®ï¼Œåè€…åˆ™æ˜¯å®¢æˆ·ç«¯æœåŠ¡ç«¯åŒå‘é€šä¿¡åè®®ï¼Œä¹Ÿå°±æ˜¯åŒæ–¹ç»´æŒä¸€ä¸ªé•¿è¿æ¥å¯äº’ç›¸å‘é€æ¶ˆæ¯ã€‚éšç€ä¸šåŠ¡çš„ä¸æ–­å‘å±•ï¼Œè¿˜è¡ç”Ÿå‡ºäº†æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯å•å‘æ¨é€æ•°æ®çš„åè®®ï¼Œé‚£å°±æ˜¯æœ¬æ–‡çš„ä¸»è§’``SSEï¼ˆServer-Sent Eventsï¼‰``

## æ ¸å¿ƒæ¦‚å¿µ

``Server-Sent Events``ï¼ˆæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼‰æ˜¯``HTML5``è§„èŒƒä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘æµè§ˆå™¨æ¨é€å®æ—¶æ•°æ®ã€‚å®ƒæ˜¯ä¸€ç§å•å‘é€šä¿¡åè®®ï¼Œæ•°æ®åªèƒ½ä»æœåŠ¡å™¨æµå‘å®¢æˆ·ç«¯ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- å•å‘é€šä¿¡ï¼šæ•°æ®ä¼ è¾“æ–¹å‘ä¸ºæœåŠ¡å™¨â†’å®¢æˆ·ç«¯
- åŸºäº``HTTP``ï¼šä½¿ç”¨æ ‡å‡†``HTTP``åè®®ï¼ŒæœåŠ¡ç«¯ä¿æŒè¿æ¥æ‰“å¼€ï¼ˆç”±äºæ˜¯åŸºäº``http``çš„åè®®æ‰€ä»¥ä¸ä»…å¯ä»¥é€šè¿‡æµè§ˆå™¨æä¾›çš„``EventSource Api``è°ƒç”¨ï¼Œè¿˜å¯ä»¥é€šè¿‡æ™®é€šçš„``fetch``è¯·æ±‚è°ƒç”¨ï¼‰
- è‡ªåŠ¨é‡è¿ï¼šæµè§ˆå™¨å†…ç½®é‡è¿æœºåˆ¶
- ç®€å•æ ¼å¼ï¼šä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ä¼ è¾“æ•°æ®

### SSEæ¶ˆæ¯æ ¼å¼
```js
data: è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯
data: è¿™æ˜¯å¦ä¸€æ¡æ¶ˆæ¯

id: 123
event: customEvent
data: {"key": "value"}

retry: 5000
```
### ä¸»è¦ä¼˜åŠ¿
- è‡ªåŠ¨é‡è¿ï¼šè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¯•
- å†…ç½®ç¼“å†²ï¼šæµè§ˆå™¨å¤„ç†æ•°æ®ç¼“å†²
- äº‹ä»¶ç±»å‹ï¼šæ”¯æŒä¸åŒç±»å‹çš„æ¶ˆæ¯
- è¿æ¥ç®¡ç†ï¼šæµè§ˆå™¨è‡ªåŠ¨ç®¡ç†è¿æ¥çŠ¶æ€

### å±€é™æ€§
- å•å‘é€šä¿¡ï¼šæ— æ³•ä»å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®
- åè®®é™åˆ¶ï¼šä»…æ”¯æŒ``HTTP GET``æ–¹æ³•
- å‚æ•°å›ºå®šï¼š``URL``å‚æ•°åœ¨è¿æ¥å»ºç«‹æ—¶ç¡®å®šï¼Œæ— æ³•åŠ¨æ€æ›´æ”¹
- è¯·æ±‚å¤´é™åˆ¶ï¼šæ— æ³•æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆå¦‚è®¤è¯ä¿¡æ¯ï¼‰

ä»‹ç»å®Œäº†åŸºæœ¬æ¦‚å¿µï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬å¼€å§‹æ‰‹æ’¸ä¸€ä¸ªæ„Ÿå—ä¸€ä¸‹ã€‚

ç›®å‰å¸‚é¢ä¸Šçš„pcç«¯aiå¯¹è¯å±‚å‡ºä¸ç©·ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°aiåœ¨å›å¤æ¶ˆæ¯çš„æ—¶å€™æ˜¯æœ‰ä¸€ä¸ªæ‰“å­—æœºçš„æ•ˆæœçš„ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æ¸²æŸ“å…¨éƒ¨å†…å®¹ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©``SSE``åè®®æ¥å®ç°ã€‚

## æœåŠ¡ç«¯å®è·µ

é¦–å…ˆæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ª``nodejs``æœåŠ¡ï¼Œç„¶åå†™å…¥å¦‚ä¸‹ä»£ç 
```js
const express = require('express');
const app = express();
const port = process.env.PORT || 3000;
const {doc} = require('./data')

app.listen(port, () => {
    console.log(`expressæœåŠ¡å·²å¯åŠ¨ï¼Œç«¯å£å·ï¼š ${port}`);
    console.log('\x1b[36m%s\x1b[0m', `ğŸ‘‰ ç‚¹å‡»è¿™é‡Œè®¿é—®: http://localhost:${port}/getReqText`); // é’è‰²æ˜¾ç¤º
    console.log('\x1b[32m%s\x1b[0m', `ğŸŒ æˆ–è€…è®¿é—®: http://127.0.0.1:${port}/getReqText`); // ç»¿è‰²æ˜¾ç¤º
})

app.get('/',(req,res)=>{
    res.send('<!DOCTYPE html>\n' +
        '<html lang="zh-CN">\n' +
        '<head>\n' +
        '    <meta charset="UTF-8">\n' +
        '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
        '    <title>æ— è„šå°é¸Ÿ</title></head>' +
        '<body>' +
        '<div>expressæœåŠ¡ï¼Œ3000ç«¯å£</div>' +
        '</body>' +
        '</html>')
})

app.get('/getReqText', (req, res) => {
    // è®¾ç½®å“åº”å¤´
    res.set({
        "Content-type": "text/event-stream",
        "Cache-Control": "no-cache",
        "Connection":"keep-alive",
    })
    // æ¨¡æ‹Ÿä»æŸä¸ªåœ°æ–¹è·å–ç”¨æˆ·æ¶ˆæ¯ï¼ˆå®é™…åº”ä» req.body ä¸­è¯»å–ï¼‰
    const userMessage = req.body?.message || 'ä½ å¥½';

    let index = 0;
    const textArray = [...doc];
    // å‘é€å“åº”å¤´
    res.flushHeaders()
    const timer = setInterval(() => {
        if (index < textArray.length) {
            // æ„é€  SSE æ•°æ®å—ï¼šdata: JSONå­—ç¬¦ä¸²\n\n
            const data = {
                content: textArray[index],
                finish_reason: null,
            };
            res.write(`data: ${JSON.stringify(data)}\n\n`);
            index++;
        } else {
            // å‘é€ç»“æŸæ ‡å¿—ï¼ˆå¯é€‰ï¼Œå¾ˆå¤š API ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„ [DONE] æ¶ˆæ¯ï¼‰
            res.write(`data: {"content":"","finish_reason":"stop"}\n\n`);
            clearInterval(timer);
            res.end(); // å…³é—­å“åº”
        }
    }, 100);

    // å¦‚æœå®¢æˆ·ç«¯æ–­å¼€äº†è¿æ¥ï¼Œæ¸…é™¤å®šæ—¶å™¨é¿å…å†…å­˜æ³„æ¼
    req.on('close', () => {
        clearInterval(timer);
        res.end();
    });
})

```
æˆ‘ä»¬ä¸»è¦å§è§†è§’èšç„¦åœ¨``getReqText``è¿™ä¸ªæ¥å£ä¸Šï¼Œä¸»è¦å…³æ³¨ç‚¹æœ‰å¦‚ä¸‹ä¸¤ä¸ªï¼š
- è®¾ç½®å“åº”å¤´``Content-type``ä¸º``text/event-stream``ã€‚ä¹Ÿå°±æ˜¯å‘Šè¯‰æµè§ˆå™¨è¿™ä¸ªæ¥å£å°†å“åº”æµå¼æ•°æ®
- ä¸ä¸€æ¬¡æ€§å“åº”æ‰€æœ‰å†…å®¹ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå®šæ—¶å™¨ä¸€ç‚¹ä¸€ç‚¹çš„å“åº”ï¼Œç›´åˆ°æ‰€æœ‰å†…å®¹å“åº”å®Œæˆä¹‹ååœ¨ç»“æŸè¿™ä¸ªè¿æ¥

æ¥ä¸‹æ¥çœ‹çœ‹å®¢æˆ·ç«¯ä»£ç 
```js
// é“¾æ¥sse
const handleConnectEvents = () => {
    eventSource = new EventSource('/api/getReqText')
    const aiResponse = {
        id: Date.now() + 1,
        // content: getAIResponse(userMessage.content),
        content: '',
        sender: 'ai',
        timestamp: new Date()
    };
    messages.value.push(aiResponse);
    eventSource.onmessage = event=>{
        console.log("ğŸ‘‰ ~ connectEvent ~ event:", event);
        messages.value[messages.value.length - 1].content += JSON.parse(event.data).content;
    }
}
```
é€šè¿‡``new EventSource``å»è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œéå¸¸çš„ç®€å•ï¼Œæˆ‘ä»¬å»ºç«‹å¥½è¿æ¥ä¹‹åå°±å¯ä»¥åœ¨``eventSource.onmessage``çš„å›è°ƒé‡Œæ¥æ”¶åˆ°æœåŠ¡ç«¯æ¨é€çš„æ¶ˆæ¯

* æ³¨æ„ï¼šæœåŠ¡ç«¯å¿…é¡»å“åº”æ­£ç¡®çš„``SSE``åè®®æ•°æ®æ ¼å¼æ‰èƒ½å‡ºå‘``onmessage``å›è°ƒï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡ä¸­çš„``res.write(`data: ${JSON.stringify(data)}\n\n`);``,å¿…é¡»æ˜¯`` data:xxx \n\n`` è¿™ç§ã€‚


åœ¨ ``SSE ``åè®®ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯å¯ä»¥ç”±å¤šä¸ªå­—æ®µç»„æˆï¼Œå…¶ä¸­ï¼š
- ``event``: å­—æ®µç”¨äºæŒ‡å®šäº‹ä»¶çš„ç±»å‹ï¼ˆåç§°ï¼‰
- ``data``: å­—æ®µåŒ…å«å®é™…çš„æ•°æ®å†…å®¹
- æ¶ˆæ¯ä»¥ ```\n\n``` ç»“å°¾

å½“å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼š
- å¦‚æœæ¶ˆæ¯ä¸­æœ‰``` event: xxx```ï¼Œåˆ™ä¼šè§¦å‘åä¸º``` xxx``` çš„è‡ªå®šä¹‰äº‹ä»¶
- å¦‚æœæ²¡æœ‰``` event``` å­—æ®µï¼Œåˆ™é»˜è®¤è§¦å‘ ``message ``äº‹ä»¶

æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ° èƒ½è¯†åˆ«çš„æ•°æ®ä¼šåœ¨``eventStream``é‡Œåˆ—å‡ºæ¥

<img class="img" src="../../.vuepress/public/sse-1.png">

å¯ä»¥çœ‹åˆ°ç”±äºæˆ‘ä»¬æ¥å£æ²¡æœ‰æŒ‡å®šå“åº”çš„``type``ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œæ¥æ”¶åˆ°çš„å…¨éƒ¨éƒ½æ˜¯``message``ç±»å‹ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªæœ€ç®€å•çš„``SSE``è¿æ¥ï¼Œä½†æ˜¯æˆ‘åœ¨ä»”ç»†è§‚å¯Ÿ``deepseek``çš„æ¥å£è°ƒç”¨çš„æ—¶å€™å‘ç°ï¼Œä»–å¹¶ä¸æ˜¯é€šè¿‡``EventSource``çš„æ–¹å¼å»è°ƒç”¨çš„æ¥å£ã€‚è€Œæ˜¯ä¸€ä¸ªæ™®é€šçš„``http``è¯·æ±‚ï¼Œå›é¡¾ä¸Šæ–‡è¯´çš„``SSE``åè®®çš„ä¸€äº›ç‰¹ç‚¹ï¼š
- åªæ”¯æŒ``get``è¯·æ±‚
- æ— æ³•æºå¸¦å‚æ•°
- æ— æ³•è®¾ç½®è¯·æ±‚å¤´å†…å®¹

ä½†æ˜¯è¦åšaiå¯¹è¯çš„è‚¯å®šå¾—éœ€è¦æŠŠç”¨æˆ·å‘é€çš„æ¶ˆæ¯ä¼ ç»™æœåŠ¡ç«¯ï¼Œé‚£æ˜¾ç„¶è¿™é‡Œå°±ä¸é€‚åˆé€šè¿‡``EventSource``çš„æ–¹å¼æ¥è°ƒç”¨äº†ï¼Œè€Œæ˜¯å½“ä½œæ™®é€šçš„``http``è¯·æ±‚ä¸€æ ·å»è°ƒç”¨ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ€è·¯è¯¯åŒºï¼š ï¼ˆ``SSE``å¹¶ä¸æ˜¯ä¸€ç§æ–°çš„é€šä¿¡åè®®ï¼Œä»–æ˜¯åŸºäº``http``åè®®çš„ä¸€ç§æ•°æ®æ ¼å¼åè®®ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„æ¯ä¸ªæ¶ˆæ¯ä»¥``data:``å¼€å¤´ï¼Œä»¥``\n\n``ç»“å°¾ï¼Œå¯ä»¥åŒ…å«äº‹ä»¶ç±»å‹ã€IDç­‰ã€‚è¿™ç§æ ¼å¼æœ¬èº«å¹¶ä¸é™å®šä½¿ç”¨ä»€ä¹ˆå®¢æˆ·ç«¯``API``æ¥æ¶ˆè´¹ã€‚ä½ å¯ä»¥ç”¨ä»»ä½•èƒ½è¯»å–``HTTP``å“åº”çš„æ–¹å¼ï¼ˆæ¯”å¦‚``fetch``çš„``ReadablStream``ï¼‰æ¥æ¥æ”¶å¹¶è§£æå®ƒï¼‰

è€Œ``EventSource``æ˜¯æµè§ˆå™¨å†…ç½®çš„ä¸€ä¸ªä¸“ç”¨å®¢æˆ·ç«¯``API``ï¼Œå®ƒæ˜¯ä¸“é—¨ç”¨æ¥æ¶ˆè´¹``SSE``æ ¼å¼çš„æ•°æ®æµï¼Œä½†ä»…é™äº``Get``è¯·æ±‚ï¼Œä¸”æ— æ³•è‡ªå®šä¹‰è¯·æ±‚å¤´ã€‚å®ƒçš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ç®€å•åœºæ™¯ï¼šæ¯”å¦‚å•çº¯çš„æœåŠ¡å™¨æ¨é€ï¼Œå®¢æˆ·ç«¯åªéœ€è¦ç›‘å¬ä¸€ä¸ªå›ºå®šçš„``URL``ï¼Œæ— éœ€å‘é€é¢å¤–çš„æ•°æ®ï¼Œ``EventSource``å¼€ç®±å³ç”¨ï¼Œè‡ªåŠ¨å¤„ç†é‡è¿ã€äº‹ä»¶åˆ†å‘ã€‚

ç”±äºæˆ‘ä»¬è¿™é‡Œåšçš„AIå¯¹è¯æ˜¯éœ€è¦å®¢æˆ·ç«¯å°†ç”¨æˆ·æ¶ˆæ¯æºå¸¦å‘é€ç»™æœåŠ¡ç«¯çš„ï¼Œæ‰€ä»¥æ˜¾ç„¶``EventSource``å¹¶ä¸é€‚ç”¨ã€‚

ä¹Ÿå°±æ˜¯è¯´``SSE``åè®®å’Œ``EventSource``å¹¶ä¸æ˜¯å¼ºç»‘å®šå…³ç³»ï¼Œè¿™ä¸ªæ€æƒ³è¯¯åŒºä¸€å®šè¦æ‰“å¼€ã€‚

é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡æ™®é€šçš„``fetch``è¯·æ±‚æ¥è¯•ä¸€è¯•å§
```js
const sendMessage = async () => {
  if (!newMessage.value.trim()) return;

  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  const userMessage = {
    id: Date.now(),
    content: newMessage.value,
    sender: 'user',
    timestamp: new Date()
  };

  messages.value.push(userMessage);
  newMessage.value = '';

  // æ¨¡æ‹ŸAIæ€è€ƒ
  isTyping.value = true;

  const response = await fetch('/api/getReqText', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ userMessage })
  });
  const aiResponse = {
    id: Date.now() + 1,
    // content: getAIResponse(userMessage.content),
    content: '',
    sender: 'ai',
    timestamp: new Date()
  };
  messages.value.push(aiResponse);
  isTyping.value = false;
  let buffer = '';
  let updateTimer = null;
  // è·å–å¯è¯»æµ
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream: true });
    buffer += chunk;
    console.log(chunk);
    const lines = buffer.split('\n');
    buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸å®Œæ•´çš„è¡Œ
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const jsonStr = line.slice(6);
        if (jsonStr === '[DONE]') {
          // å¯¹è¯ç»“æŸ
          return;
        }
        try {
          const data = JSON.parse(jsonStr);
          const content = data.content; // æå–æ–‡æœ¬ç‰‡æ®µ
          // è¿½åŠ åˆ° UI
          messages.value[messages.value.length - 1].content += content;
          if (data.finish_reason === 'stop') {
            // å›å¤ç»“æŸï¼Œå¯ä»¥åšäº›æ¸…ç†
          }
        } catch (e) {
          console.error('è§£æå¤±è´¥', e);
        }
      }
    }
  }
};
```
è¿™é‡Œå°±æ˜¯é€šè¿‡åˆ›å»º``fetch``å“åº”ä½“çš„ä¸€ä¸ªå¯è¯»æµï¼Œç„¶åé€šè¿‡å¾ªç¯å»ä¸æ–­çš„è¯»å–ï¼Œç›´åˆ°è¿™ä¸ªæµå“åº”ç»“æŸã€‚

æ‰€ä»¥ä»¥åé¢è¯•å®˜é—®èµ·ä½ ``SSE``ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸€å®šè¦æŠŠå®ƒå’Œ``EventSource``åŒºåˆ†å¼€å“¦ã€‚``SSE``æ˜¯ä¸€ç§æ•°æ®æ ¼å¼åè®®ï¼Œè€Œ``EventSource``æ˜¯ä¸“é—¨ç”¨æ¥æ¶ˆè´¹``SSE``åè®®çš„``Api``ã€‚æ‰€è°“çš„æœåŠ¡ç«¯ä¸»åŠ¨é€šçŸ¥æœåŠ¡ç«¯å…¶å®å°±æ˜¯æœåŠ¡ç«¯ä¿æŒä¸€ä¸ªé•¿è¿æ¥ä¸æ–­å¼€ï¼Œç„¶åå‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯

ä»¥ä¸Šå°±æ˜¯å¯¹SSEåè®®çš„è¯¦ç»†è§£è¯»ä»¥åŠå®æ“æ‹‰ï¼Œæ³¨æ„å…¶ä¸­å‡ ä¸ªæ¦‚å¿µï¼Œä¸Šæ‰‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼