---
title: å®ç°ä¸€ä¸ªç®€æ˜“çš„Webpack-plugin
date: 2023-05-18 17:27:53
permalink: /pages/fe18f6/
categories:
  - æŠ€æœ¯
  - WebPack
tags:
  - 
---
## å‰è¨€
> pluginåœ¨webpackä¸­ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œä»–å¯ä»¥æä¾›ç»™äº†ç”¨æˆ·åœ¨webpackæ‰§è¡Œçš„ä»»æ„å‘¨æœŸçš„é’©å­ï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨ä»»æ„åœ°æ–¹å»ç©¿æ’è‡ªå·±çš„æƒ³æ³•ï¼Œä»è€Œæ”¹å˜æ„å»ºç»“æœã€‚ä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹ä¸€ä¸ªpluginå§
## åŸºæœ¬ç»“æ„
ä¸€ä¸ªæœ€åŸºæœ¬çš„ plugin éœ€è¦åŒ…å«è¿™äº›éƒ¨åˆ†ï¼š
- ä¸€ä¸ª JavaScript ç±»
- ä¸€ä¸ª apply æ–¹æ³•ï¼Œapply æ–¹æ³•åœ¨ webpack è£…è½½è¿™ä¸ªæ’ä»¶çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”ä¼šä¼ å…¥ compiler å¯¹è±¡ã€‚
- ä½¿ç”¨ä¸åŒçš„ hooks æ¥æŒ‡å®šè‡ªå·±éœ€è¦å‘ç”Ÿçš„å¤„ç†è¡Œä¸º
- åœ¨å¼‚æ­¥è°ƒç”¨æ—¶æœ€åéœ€è¦è°ƒç”¨ webpack æä¾›ç»™æˆ‘ä»¬çš„ callback æˆ–è€…é€šè¿‡ Promise çš„æ–¹å¼ï¼ˆåç»­å¼‚æ­¥ç¼–è¯‘éƒ¨åˆ†ä¼šè¯¦ç»†è¯´ï¼‰

```js
/**
 * hookName éœ€è¦è®¢é˜…çš„hookçš„åç§°
 * PluginName ä½ çš„æ’ä»¶åç§°ï¼Œå­—ç¬¦ä¸²æ ¼å¼
 */
class HelloPlugin{
  apply(compiler){
    compiler.hooks[hookName].tap(PluginName,(params)=>{
      /** do some thing */
    })
  }
}
module.exports = HelloPlugin

```
## compileå’Œcompilation
åœ¨å­¦ä¹ pluginä¹‹å‰é¦–å…ˆè¦æ¥å­¦ä¹ ä¸€ä¸‹ compileå’Œcompilationï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
ç”¨å®˜æ–¹çš„è¯æ¥è¯´
- Compileræ¨¡å—æ˜¯ webpack çš„ä¸»è¦å¼•æ“ï¼Œå®ƒé€šè¿‡CLIæˆ–è€…Node APIä¼ é€’çš„æ‰€æœ‰é€‰é¡¹åˆ›å»ºå‡ºä¸€ä¸ª compilation å®ä¾‹ã€‚ å®ƒæ‰©å±•ï¼ˆextendsï¼‰è‡ªTapableç±»ï¼Œç”¨æ¥æ³¨å†Œå’Œè°ƒç”¨æ’ä»¶ã€‚ å¤§å¤šæ•°é¢å‘ç”¨æˆ·çš„æ’ä»¶ä¼šé¦–å…ˆåœ¨Compilerä¸Šæ³¨å†Œã€‚
- Compilation æ¨¡å—ä¼šè¢« Compiler ç”¨æ¥åˆ›å»ºæ–°çš„ compilation å¯¹è±¡ï¼ˆæˆ–æ–°çš„ build å¯¹è±¡ï¼‰ã€‚ compilation å®ä¾‹èƒ½å¤Ÿè®¿é—®æ‰€æœ‰çš„æ¨¡å—å’Œå®ƒä»¬çš„ä¾èµ–ï¼ˆå¤§éƒ¨åˆ†æ˜¯å¾ªç¯ä¾èµ–ï¼‰ã€‚ å®ƒä¼šå¯¹åº”ç”¨ç¨‹åºçš„ä¾èµ–å›¾ä¸­æ‰€æœ‰æ¨¡å—ï¼Œ è¿›è¡Œå­—é¢ä¸Šçš„ç¼–è¯‘(literal compilation)ã€‚ åœ¨ç¼–è¯‘é˜¶æ®µï¼Œæ¨¡å—ä¼šè¢«åŠ è½½(load)ã€å°å­˜(seal)ã€ä¼˜åŒ–(optimize)ã€ åˆ†å—(chunk)ã€å“ˆå¸Œ(hash)å’Œé‡æ–°åˆ›å»º(restore)ã€‚

é€šä¿—ä¸€ç‚¹å°†å°±æ˜¯compileræ˜¯webpackçš„å®ä¾‹ï¼Œä»–è´¯ç©¿äº†æ•´ä¸ªwebpackçš„ä¸€ç”Ÿï¼Œä»–è´Ÿè´£æŒ‡æŒ¥æ•´ä¸ªæ‰“åŒ…è¿‡ç¨‹ï¼Œè€ŒCompilationå°±åƒæ˜¯compilerçš„å°å…µä¸€æ ·ï¼Œè´Ÿè´£å®æ–½æ„å»ºè¿™ä¸€è¿‡ç¨‹ã€‚åŒæ—¶ä»–ä»¬éƒ½æ˜¯ç»§æ‰¿è‡ªTapableè¿™ä¸€äº‹ä»¶æµæœºåˆ¶ã€‚æ‰€ä»¥ä»–ä»¬æä¾›äº†å¤§é‡çš„é’©å­ç»™ç”¨æˆ·è®¢é˜…ï¼Œè®¢é˜…ä¸åŒçš„é’©å­å°±å¯ä»¥ä¼ å…¥ä¸åŒçš„å›è°ƒå‡½æ•°ï¼Œwebpackå›å»é€ä¸€æ‰§è¡Œè¿™äº›å›è°ƒã€‚ç„¶åæ”¹å˜æ„å»ºç»“æœ

è€Œpluginçš„hookä¹Ÿæ˜¯æœ‰åŒæ­¥å¼‚æ­¥ä¹‹åˆ†çš„ã€‚ä¸åŒçš„æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ç”¨ä¸åŒçš„æ–¹æ³•å»è®¢é˜…ã€‚åŒæ­¥çš„æƒ…å†µä¸‹é‡‡ç”¨tapæ–¹æ³•è®¢é˜…ã€‚
```js
    compiler.hooks[hookName].tap(PluginName,(params)=>{
      /** do some thing */
    })
```
è€Œå¼‚æ­¥çš„æƒ…å†µä¸‹åˆåˆ†ä¸ºtapAsyncå’ŒtapPromiseä¸¤ç§æ–¹å¼ï¼Œè¿™ä¸¤ç§è®¢é˜…æ–¹å¼çš„å†™æ³•ä¹Ÿæœ‰ç»†å¾®çš„åŒºåˆ«

**tapAsync**
>ä½¿ç”¨ tapAsync çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¤šä¼ å…¥ä¸€ä¸ª callback å›è°ƒï¼Œå¹¶ä¸”åœ¨ç»“æŸçš„æ—¶å€™ä¸€å®šè¦è°ƒç”¨è¿™ä¸ªå›è°ƒå‘ŠçŸ¥ webpack è¿™æ®µå¼‚æ­¥æ“ä½œç»“æŸäº†ã€‚ğŸ‘‡ æ¯”å¦‚ï¼š

```js

class HelloPlugin {
  apply(compiler) {
    compiler.hooks.emit.tapAsync(HelloPlugin, (compilation, callback) => {
      setTimeout(() => {
        console.log('async')
        callback()
      }, 1000)
    })
  }
}
module.exports = HelloPlugin

```
**tapPromise**
>å½“ä½¿ç”¨ tapPromise æ¥å¤„ç†å¼‚æ­¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ª Promise å¯¹è±¡å¹¶ä¸”è®©å®ƒåœ¨ç»“æŸçš„æ—¶å€™ resolve ğŸ‘‡
```js
class HelloPlugin {
  apply(compiler) {
    compiler.hooks.emit.tapPromise(HelloPlugin, (compilation) => {
      return new Promise((resolve) => {
        setTimeout(() => {
          console.log('async')
          resolve()
        }, 1000)
      })
    })
  }
}
module.exports = HelloPlugin

```
## å®è·µ
ä¸‹é¢é€šè¿‡ä¸€ä¸ªå°æ —å­æ¥æ„Ÿå—ä¸€ä¸‹è‡ªå®šä¹‰plugin

è¿™ä¸ªæ’ä»¶å®ç°çš„åŠŸèƒ½æ˜¯åœ¨æ‰“åŒ…åè¾“å‡ºçš„æ–‡ä»¶å¤¹å†…å¤šå¢åŠ ä¸€ä¸ª markdown æ–‡ä»¶ï¼Œæ–‡ä»¶å†…è®°å½•æ‰“åŒ…çš„æ—¶é—´ç‚¹ã€æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤§å°çš„è¾“å‡ºã€‚

é¦–å…ˆæˆ‘ä»¬æ ¹æ®éœ€æ±‚ç¡®å®šæˆ‘ä»¬éœ€è¦çš„ hook ï¼Œç”±äºéœ€è¦è¾“å‡ºæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ compilation çš„ emitAsset æ–¹æ³•ã€‚
å…¶æ¬¡ç”±äºéœ€è¦å¯¹ assets è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ compilation.hooks.processAssets ï¼Œå› ä¸º processAssets æ˜¯è´Ÿè´£ asset å¤„ç†çš„é’©å­ã€‚
è¿™æ ·æˆ‘ä»¬æ’ä»¶ç»“æ„å°±å‡ºæ¥äº†

```js
class OutLogPlugin {
  constructor(options) {
    this.outFileName = options.outFileName
  }
  apply(compiler) {
    // å¯ä»¥ä»ç¼–è¯‘å™¨å¯¹è±¡è®¿é—® webpack æ¨¡å—å®ä¾‹
    // å¹¶ä¸”å¯ä»¥ä¿è¯ webpack ç‰ˆæœ¬æ­£ç¡®
    const { webpack } = compiler
    // è·å– Compilation åç»­ä¼šç”¨åˆ° Compilation æä¾›çš„ stage
    const { Compilation } = webpack
    const { RawSource } = webpack.sources
    /** compiler.hooks.<hoonkName>.tap/tapAsync/tapPromise */
    compiler.hooks.compilation.tap('OutLogPlugin', (compilation) => {
      compilation.hooks.processAssets.tap(
        {
          name: 'OutLogPlugin',
          // é€‰æ‹©é€‚å½“çš„ stageï¼Œå…·ä½“å‚è§ï¼š
          // https://webpack.js.org/api/compilation-hooks/#list-of-asset-processing-stages
          stage: Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE,
        },
        (assets) => {
          let resOutput = `buildTime: ${new Date().toLocaleString()}\n\n`
          resOutput += `| fileName  | fileSize  |\n| --------- | --------- |\n`
          Object.entries(assets).forEach(([pathname, source]) => {
            resOutput += `| ${pathname} | ${source.size()} bytes |\n`
          })
          compilation.emitAsset(
            `${this.outFileName}.md`,
            new RawSource(resOutput),
          )
        },
      )
    })
  }
}
module.exports = OutLogPlugin

```
## æ€»ç»“
webpackæ’ä»¶ä¸»è¦æ˜¯åˆ©ç”¨äº†webpackçš„```compile```å®ä¾‹å’Œ```compilation```å®ä¾‹ç»§æ‰¿è‡ª```Tapable```ç±»ï¼Œæä¾›äº†ä¸€ç³»åˆ—çš„é’©å­å¯ä¾›ç”¨æˆ·```è®¢é˜…```ã€‚ç”¨æˆ·åœ¨```è®¢é˜…```è¿™äº›é’©å­çš„åŒæ—¶ä¼ å…¥```å›è°ƒå‡½æ•°```ï¼Œwebpackå°±ä¼šå»é€ä¸€æ‰§è¡Œã€‚ä»è€Œ```æ”¹å˜```æ„å»ºç»“æœã€‚è®¢é˜…æ–¹å¼ä¹Ÿåˆ†ä¸º```åŒæ­¥è®¢é˜…```å’Œ```å¼‚æ­¥è®¢é˜…```ã€‚åŒæ­¥è®¢é˜…é‡‡ç”¨```tap```æ–¹æ³•ï¼Œä¼ å…¥æ’ä»¶åå’Œå›è°ƒå³å¯ã€‚```å¼‚æ­¥è®¢é˜…```åˆ†ä¸º```tapAsync```å’Œ```tapPromise```ä¸¤ç§æ–¹å¼ï¼Œ
```tapAsync```çš„å›è°ƒä¸­å¤šæ¥å—ä¸€ä¸ª```callback```å‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨```callback```æ¥å‘Šè¯‰```webpack```å¼‚æ­¥å®Œæˆäº†ã€‚```tapPromise```åˆ™æ˜¯åœ¨å›è°ƒå‡½æ•°é‡Œè¿”å›ä¸€ä¸ª```promise```ï¼Œç„¶å```resolve```æ¥å‘Šè¯‰webpack```å¼‚æ­¥ç»“æŸ```ã€‚
