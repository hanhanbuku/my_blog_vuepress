---
title: å®ç°ä¸€ä¸ªå°ç¨‹åºæŒç»­é›†æˆå·¥å…·
date: 2023-05-23 16:14:32
permalink: /pages/ab1d89/
categories:
  - æŠ€æœ¯
  - å·¥ç¨‹åŒ–ç›¸å…³
tags:
  - 
---
## å‰è¨€
>åœ¨å¼€å‘å°ç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å‘å¸ƒç‰ˆæœ¬éœ€è¦æäº¤ä»£ç è¿™ä¸ªæ­¥éª¤ã€‚é‚£æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥åƒæ­£å¸¸çš„å‰ç«¯é¡¹ç›®çš„æµæ°´çº¿è‡ªåŠ¨åŒ–çš„å»æ‰§è¡Œè¿™ä¸€æ­¥å‘¢ï¼Ÿå¾®ä¿¡å®˜æ–¹æ˜¯æœ‰æä¾›ä¸€ä¸ªciçš„å·¥å…·åº“çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±åŸºäºè¿™ä¸ªå·¥å…·åº“å°è£…ä¸€ä¸ªè‡ªå·±çš„ciå·¥å…·ï¼Œå‘å¸ƒåˆ°npmä¸Š

## å°ç¨‹åºæŒç»­é›†æˆ
â± å°ç¨‹åºæŒç»­é›†æˆ ciï¼ŒåŸºäº [miniprogram-ci](https://www.npmjs.com/package/miniprogram-ci) å®ç°

å…·ä½“çš„æ–‡æ¡£å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ï¼Œä¸‹é¢æ¥ç®€å•æè¿°ä¸€ä¸‹æˆ‘ä»¬è‡ªå·±çš„å·¥å…·åŒ…åº”è¯¥å¦‚ä½•å¼€å‘

## åˆå§‹åŒ–
é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶å»ºç«‹å¥½ç›®å½•ç»“æ„
![img.png](../../.vuepress/public/gc_1.png)

æŠŠä¸€äº›æµç¨‹åŒ–çš„å·¥å…·å®‰è£…å¥½ï¼Œæ¯”å¦‚commitlintï¼Œstandard-versionï¼Œhuskyï¼Œrollupç­‰ç­‰ã€‚è¿˜æœ‰å…¶ä»–éœ€æ±‚çš„å¯ä»¥è‡ªå·±å®‰è£…ã€‚

ä¸‹é¢å°±å¼€å§‹å»å†™æ„å»ºè„šæœ¬
## lib
å…ˆå®‰è£…ä¸€ä¸‹å¾®ä¿¡çš„ci **(æ³¨æ„ï¼Œè¿™é‡Œå®‰è£…åŒ…éœ€è¦ä¸¥æ ¼åŒºåˆ†ä¸€ä¸‹devDependencieså’Œdependenciesï¼Œä½œä¸ºä¸€ä¸ªå·¥å…·ï¼Œè¢«ç”¨æˆ·å®‰è£…çš„æ—¶å€™æ˜¯åªä¼šä¸‹è½½dependenciesé‡Œçš„ä¾èµ–çš„ï¼Œæ‰€ä»¥ä½ çš„åŒ…è¿è¡Œå¿…é¡»è¦çš„ä¾èµ–è¯·å¸è½½dependenciesé‡Œ)**
```shell
pnpm install miniprogram-ci
```

miniprogram-ciçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œçœ‹æ–‡æ¡£å°±è¡Œã€‚æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯å¯¹ä»–è¿›è¡Œä¸€ä¸ªäºŒæ¬¡å°è£…ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ çš„æ–¹ä¾¿

åœ¨æˆ‘ä»¬çš„ciæ–‡ä»¶é‡Œå†™ä¸Šå¦‚ä¸‹å†…å®¹
```js
const ci = require('miniprogram-ci')
const utils = require('./utils')

export default class mpCi {
    constructor(options) {
        this.options = options
        this.project = null
    }

    init() {
        this.project = new ci.Project({...this.options.config()})
        const baseConfig = () => ({
            project: this.project,
            version: this.options.baseConfig().version || utils.getVersion(),
            desc: this.options.baseConfig().desc,
            robot: this.options.baseConfig().desc.robot || 30,
            setting: this.options.baseConfig().setting ?? {
                es6: true,
                es7: true,
            },
        })
        this.upload(baseConfig)
        this.preview(baseConfig)
    }

    upload(baseConfig) {
        ci.upload({
            ...baseConfig(),
            onProgressUpdate: ({_status, _msg}) => {
                if (_status === 'done') {
                    console.log(`ğŸš  ${_msg}\n`)
                }
            },
        }).then(({subPackageInfo}) => {
            console.log(
                '\nğŸŒˆ ä½“éªŒç‰ˆä¸Šä¼ æˆåŠŸ\n\n' +
                'åˆ†åŒ…ä¿¡æ¯ï¼š\n' +
                subPackageInfo.reduce((pre, curr) => {
                    return pre + `${curr.name}: ${curr.size / 1000}kb\n`
                }, ''),
            )
        }).catch((e) => {
            console.log('\nğŸ›  ä½“éªŒç‰ˆä¸Šä¼ å¤±è´¥\n', e)
            process.exit(1)
        })
    }

    preview(baseConfig) {
        ci.preview({
            ...baseConfig(),
            onProgressUpdate: () => {
            },
            qrcodeFormat: 'base64',
            qrcodeOutputDest: 'qrcode.text',
        }).then(({subPackageInfo}) => {
            console.log(
                '\nğŸŒˆ é¢„è§ˆä¸Šä¼ æˆåŠŸ\n\n' +
                'åˆ†åŒ…ä¿¡æ¯ï¼š\n' +
                subPackageInfo.reduce((pre, curr) => {
                    return pre + `${curr.name}: ${curr.size / 1000}kb\n`
                }, ''),
            )
        }).catch((e) => {
            console.log('\nğŸ›  é¢„è§ˆä¸Šä¼ å¤±è´¥\n', e)
            process.exit(1)
        })
    }
}

```
## index
```js
import mpCi from './lib/ci'

function tyrGet(target){
    if(!target){
        return null
    }
    if(target instanceof Function){
        return target()
    }
    return target
}
export const run = function (options){
    const {config,baseConfig} = options
    try {
        const ci = new mpCi({config:tyrGet(config),baseConfig:tyrGet(baseConfig)})
        ci.init()
    }catch (err){
        console.log('åˆå§‹åŒ–å¤±è´¥ï¼š'+ err)
    }
}

```
## ä½¿ç”¨
```js
run({
    config(){
        return{
            appid: "wxsomeappid",
            type: "miniProgram",
            projectPath: path.resolve(process.cwd(), "./dist/"),
            privateKeyPath: path.resolve(process.cwd(), "./dist/"),
            ignores: ["node_modules/**/*"],  
        }
    },
    baseConfig(){
        return{
            version:"ç‰ˆæœ¬å·",
            desc: "æ›´æ–°æè¿°",
            robot: "æœºå™¨äººåºå·",
            setting: {
                es6: true,
                es7: true,
            },
        }
    }
})
```
## æ³¨æ„

å…¶ä»–æ²¡ä»€ä¹ˆå¥½è¯´çš„ä¸»è¦æä¸€ä¸‹```privateKeyPath```,åœ¨åˆå§‹åŒ–ciçš„æ—¶å€™å¯ä»¥é€‰æ‹©ä¼ å…¥```privateKeyPath```æˆ–è€…```privateKey```ï¼ŒäºŒè€…é€‰æ‹©å…¶ä¸€å°±è¡Œã€‚è¿™ä¸ª```å¯†é’¥```æ˜¯åœ¨```å¾®ä¿¡å…¬ä¼—å¹³å°```ä¸‹è½½çš„ï¼Œä¸‹è½½æ–¹æ³•å¯ä»¥çœ‹æ–‡ç« å¼€å¤´è´´çš„ciçš„å®˜æ–¹æ–‡æ¡£ã€‚
ã€‚å¦‚æœæœ‰æµæ°´çº¿çš„è¯æ¨èä½¿ç”¨å¯†é’¥çš„å€¼çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»“åº“æµæ°´çº¿çš„å˜é‡é‡Œå°†å¯†é’¥é…ç½®è¿›å»ã€‚ç„¶ååœ¨ciè„šæœ¬é‡Œæ‰§è¡Œæˆ‘ä»¬è¿™ä¸ªuploadè„šæœ¬çš„æ—¶å€™é€šè¿‡`````--xxx```çš„å½¢å¼æŠŠå¯†é’¥è¾“å…¥ä¸Šå»ã€‚åœ¨è„šæœ¬ä¸­å¯ä»¥é€šè¿‡```process.argv```è·å–åˆ°è¿™ä¸ª--xxxå‚æ•°ã€‚
è¿™ç§åŠæ³•æ—¢å®‰å…¨æœ‰çœåŠ›ã€‚

ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹

```js
//å‡è®¾æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œéƒ½å·²ç»åšå¥½äº†ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆå»è·å–è¿™ä¸ªprivateKeyå‘¢

/**
 * é€šè¿‡è¿™å‡½æ•°ï¼Œå»è·å–åœ¨æ‰§è¡Œshellè„šæœ¬çš„æ—¶å€™çš„å‚æ•°
 * @param key
 * @returns {string}
 */
function getCliArg(key) {
    const args = process.argv
    const index = args.lastIndexOf(key)
    if (index !== -1) {
        return args[index + 1]
    }
}

```
åœ¨æµæ°´çº¿è„šæœ¬é‡Œè¿™æ ·å†™
```yaml
 script:
    - yarn
    - yarn build:mp-weixin:test
    - yarn mp-ci --key $MP_CLI_KEY --branch ${CI_COMMIT_BRANCH}
```
æ³¨æ„åˆ°ä¸Šé¢è„šæœ¬ä¸­çš„--keyæ²¡æœ‰ï¼Œä»–åé¢è·Ÿçš„$MP_CLI_KEY å°±æ˜¯æˆ‘ä»¬é¢„å…ˆåœ¨æµæ°´çº¿å˜é‡é‡Œé…ç½®å¥½çš„keyäº†ã€‚
è¿™æ ·ä¸€æ¥åªè¦è¿è¡Œæˆ‘ä»¬å†™çš„ciè„šæœ¬å¹¶ä¸”ä¼ å…¥--keyã€‚æˆ‘ä»¬å°±åªéœ€è¦åœ¨ä»£ç ä¸­å»è·å–è¿™ä¸ª--keyå°±å¯ä»¥äº† 
```js
run({
    config(){
        return{
             Â·Â·Â·
            privateKey:getCliArg('--key') ,
        }
    },
    baseConfig(){
        ...
    }
})
```

## æ„å»º
åœ¨æ„å»ºè¿™ä¸€å—é€‰æ‹©ä½¿ç”¨rollupï¼Œå› ä¸ºä»–æ¯”è¾ƒè½»é‡çº§ï¼Œç®€å•å¥½ç”¨ï¼Œå¹¶ä¸”å¤©ç„¶æ”¯æŒesm
å®‰è£…å¥½rollupä»¥åŠrollup-plugin-terseråï¼Œå†™ä¸ªrollup.config.jsï¼Œå¹¶å†™å…¥å¦‚ä¸‹é…ç½®
```js
import { terser } from "rollup-plugin-terser";

export default {
    input: 'src/index.js',
    output: {
        file: 'dist/index.js',
        format: 'esm'
    },
    plugins: [
        terser({ compress: { drop_console: true } })    
    ]
};

```
```shell
 "build": "npx rollup -c",
```
æ‰§è¡Œä¸€ä¸‹å°±å¯ä»¥çœ‹åˆ°æ‰“åŒ…åçš„ç»“æœäº†ã€‚

## å…³äºæ„å»º
æˆ‘ä»¬æŠŠä»£ç æ‰˜ç®¡åˆ°githubä¸Š,äº¤ç”±github actionæ¥å»å®Œæˆè¿™ä¸€äº›åˆ—çš„åŠ¨ä½œã€‚
å…·ä½“çš„ymlè„šæœ¬å¯ä»¥è¿™æ ·å†™
```yaml
# 1
name: mp-ic Package

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
#      é‡‡ç”¨pnpmçš„æ–¹å¼å»å®‰è£…ä¾èµ–
      - uses: pnpm/action-setup@v2
        with:
          #      æŒ‡å®špnpmç‰ˆæœ¬
          version: 7
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      - name: install
        run: pnpm install
      - name: build
        run: pnpm run build
      - name: publish
        run: npm publish
        env :
          NODE_AUTH_TOKEN: ${{ secrets.MPCI_NPM_TOKEN }}
```
MPCI_NPM_TOKENæ˜¯åœ¨npmé‡Œç”Ÿæˆçš„ï¼Œæ®è¯´æŠŠä»–é…åˆ°github çš„actioné‡Œå°±å¯ä»¥ç›´æ¥å‘å¸ƒã€‚ä½†æˆ‘è¯•è¿‡äº†å¥½åƒä¸å¤ªè¡Œã€‚æœ€ç»ˆè¿˜æ˜¯é‡‡ç”¨æ‰‹åŠ¨çš„å½¢å¼å»å‘å¸ƒã€‚å¦‚æœè¦è‡ªåŠ¨åŒ–çš„è¯ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚ç½‘ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤šå…ç™»å½•çš„æ–¹æ¡ˆçš„ã€‚è¿™é‡Œå°±ä¸å»åšè¿‡å¤šçš„çº ç»“äº†ã€‚ç›´æ¥é‡‡ç”¨æœ¬åœ°å‘ã€‚

æ³¨æ„åœ¨æµæ°´çº¿é‡Œæ¯ä¸€ä¸ªjobsçš„ç¯å¢ƒéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ åœ¨ä¸Šä¸€ä¸ªjobsé‡Œå®‰è£…çš„ä¸œè¥¿ã€‚åœ¨ä¸‹ä¸€ä¸ªjobsé‡Œæ˜¯ä¸èƒ½ç”¨çš„ã€‚æ‰€ä»¥æœ€å¥½æŠŠæœ‰å…³è”çš„æ­¥éª¤éƒ½æ”¾åœ¨åŒä¸€ä¸ªjobsé‡Œå»æ‰§è¡Œã€‚



## ç»“è¯­

æ•´ä½“çš„å¼€å‘å°±æ˜¯è¿™æ ·äº†ï¼Œå‰©ä¸‹å°±æ˜¯å°†è¿™ä¸ªé¡¹ç›®å‘å¸ƒåˆ°npmä¸Šã€‚å…·ä½“çš„è¿‡ç¨‹è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚æœ‰éœ€è¦å¯ä»¥è‡ªè¡Œç§»æ­¥åšå®¢é‡Œçš„npmæ•™ç¨‹
